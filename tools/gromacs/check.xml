<tool id="gmx_check" name="GROMACS check" version="@TOOL_VERSION@+galaxy@GALAXY_VERSION@">
    <description>using gmx check</description>
    <macros>
        <token name="@GALAXY_VERSION@">0</token>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        #for $i, $choice in enumerate($analysis)
            #if $choice.input_file.calculate_select == "info_traj":
                ln -s '$choice.input_file.traj_file' './$i.$choice.input_file.traj_file.element_identifier';
                gmx check
                    -f './$i.$choice.input_file.traj_file.element_identifier'
                    &> '${i}.Trajectory_information_for_"${choice.input_file.traj_file.element_identifier}".txt';
            #elif $choice.input_file.calculate_select == "compare_traj":
                ln -s '$choice.input_file.traj_file' './$i.$choice.input_file.traj_file.element_identifier';
                ln -s '$choice.input_file.traj_file2' './$i.$choice.input_file.traj_file2.element_identifier';
                gmx check
                    -f './$i.$choice.input_file.traj_file.element_identifier'
                    -f2 './$i.$choice.input_file.traj_file2.element_identifier'
                    $choice.input_file.rmsd
                    -tol '$choice.input_file.rel_tol'
                    -abstol '$choice.input_file.abs_tol'
                    &> '${i}.Compare_trajectories_between_"${choice.input_file.traj_file.element_identifier}"_and_"${choice.input_file.traj_file2.element_identifier}".txt';
            #elif $choice.input_file.calculate_select == "info_struc":
                ln -s '$choice.input_file.struc_file' './$i.$choice.input_file.struc_file.element_identifier';
                gmx check
                    -c './$i.$choice.input_file.struc_file.element_identifier'
                    -vdwfac '$choice.input_file.vdwfac'
                    -bonlo '$choice.input_file.bonlo'
                    -bonhi '$choice.input_file.bonhi'
                    &> '${i}.Structure_information_for_"${choice.input_file.struc_file.element_identifier}".txt';
            #elif $choice.input_file.calculate_select == "info_ener":
                ln -s '$choice.input_file.ener_file' './$i.$choice.input_file.ener_file.element_identifier' ;
                gmx check
                    -e './$i.$choice.input_file.ener_file.element_identifier'
                    &> '${i}.Energy_information_for_"${$choice.input_file.ener_file.element_identifier}".txt';
            #elif $choice.input_file.calculate_select == "info_ind":
                ln -s '$choice.input_file.ind_file' './$i.$choice.input_file.ind_file.element_identifier';
                gmx check
                    -n './$i.$choice.input_file.ind_file.element_identifier'
                    &> '${i}.Index_information_for_"${choice.input_file.ind_file.element_identifier}".txt';
            #elif $choice.input_file.calculate_select == "compare_ener":
                ln -s '$choice.input_file.ener_file' './$i.$choice.input_file.ener_file.element_identifier';
                ln -s '$choice.input_file.ener_file2' './$i.$choice.input_file.ener_file2.element_identifier';
                gmx check
                    -e './$i.$choice.input_file.ener_file.element_identifier'
                    -e2 './$i.$choice.input_file.ener_file2.element_identifier'
                    -tol '$choice.input_file.rel_tol'
                    -abstol '$choice.input_file.abs_tol'
                    -lastener '$choice.input_file.lastener'
                    &> '${i}.Compare_energies_between_"${choice.input_file.ener_file.element_identifier}"_and_"${choice.input_file.ener_file2.element_identifier}".txt';
            #else:
                ln -s '$choice.input_file.top_file' './$i.$choice.input_file.top_file.element_identifier';
                ln -s '$choice.input_file.top_file2' './$i.$choice.input_file.top_file2.element_identifier';
                gmx check
                    -s1 './$i.$choice.input_file.top_file.element_identifier'
                    -s2 './$i.$choice.input_file.top_file2.element_identifier'
                    -abstol '$choice.input_file.abs_tol'
                    &> '${i}.Compare_topologies_between_"${choice.input_file.top_file.element_identifier}"_and_"${choice.input_file.top_file2.element_identifier}".txt';
            #end if
        #end for
    ]]></command>
    <inputs>
        <repeat name="analysis" title="Type of analysis">
            <conditional name="input_file">
                <param name="calculate_select" type="select" label="Select the type of information you want to obtain">
                    <option value="info_traj">Information about a trajectory</option>
                    <option value="compare_traj">Compare two trajectories</option>
                    <option value="info_struc">Information about the system structure</option>
                    <option value="info_ener">Information about the system energy</option>
                    <option value="info_ind">Information about the system index</option>
                    <option value="compare_top">Compare two topologies</option>
                    <option value="compare_ener">Compare two energy files</option>
                </param>
                <when value="info_traj">
                    <param name="traj_file" type="data" format="xtc, trr, cpt, gro, g96, pdb, tng" label="Trajectory file" help="Enter the trajectory file. Accepted formats: xtc, trr, cpt, gro, g96, pdb, tng."/>
                </when>
                <when value="compare_traj">
                    <param name="traj_file" type="data" format="xtc, trr, cpt, gro, g96, pdb, tng" label="Trajectory file 1" help="Enter the first trajectory file. Accepted formats: xtc, trr, cpt, gro, g96, pdb, tng."/>
                    <param name="traj_file2" type="data" format="xtc, trr, cpt, gro, g96, pdb, tng" label="Trajectory file 2" help="Enter the second trajectory file. Accepted formats: xtc, trr, cpt, gro, g96, pdb, tng."/>
                    <param name="rmsd" type="boolean" truevalue="-rmsd" falsevalue="" label="Do you want to display the RMSD?"/>
                    <param name="rel_tol" type="float" max="1.0" value="0.001" label="Enter relative tolerance" help="Relative tolerance for comparing real values defined as 2*(a-b)/(|a|+|b|)."/>
                    <param name="abs_tol" type="float" max="1.0" value="0.001" optional="True" label="Enter absolute tolerance" help="Absolute tolerance, useful when sums are close to zero."/>
                </when>
                <when value="info_struc">
                    <param name="struc_file" type="data" format="tpr, gro, g96, pdb, brk, ent" label="Structure file" help="Enter the structure file. Accepted formats: tpr, gro, g96, pdb, brk, ent.">
                        <validator type="expression" message="Wrong file format">value.extension != 'edr' and value.extension != 'xtc'</validator>
                    </param>
                    <param name="vdwfac" type="float" max="1.0" value="0.8" label="Enter the fraction of sum of VdW radii sum"/>
                    <param name="bonlo" type="float" max="1.0" value="0.4" label="Enter the minimal fraction of sum of vdW radii for bonded atoms"/>
                    <param name="bonhi" type="float" max="1.0" value="0.7" label="Enter the maximal fraction of sum of vdW radii for bonded atoms"/>
                </when>
                <when value="info_ener">
                    <param name="ener_file" type="data" format="edr" label="Energy file" help="Enter the energy file. Accepted format: edr."/>
                </when>
                <when value="info_ind">
                    <param name="ind_file" type="data" format="ndx" label="Index file" help="Enter the index file. Accepted format: ndx."/>
                </when>
                <when value="compare_top">
                    <param name="top_file" type="data" format="tpr" label="Topology file 1" help="Enter the first topology file. Accepted format: tpr.">
                        <validator type="expression" message="Wrong file format">value.extension == 'tpr'</validator>
                    </param>
                    <param name="top_file2" type="data" format="tpr" label="Topology file 2" help="Enter the second topology file. Accepted format: tpr.">
                        <validator type="expression" message="Wrong file format">value.extension == 'tpr'</validator>
                    </param>
                    <param name="abs_tol" type="float" max="1.0" value="0.001" label="Enter absolute tolerance" help="Absolute tolerance, useful when sums are close to zero."/>
                </when>
                <when value="compare_ener">
                    <param name="ener_file" type="data" format="edr" label="Energy file 1" help="Enter the first energy file. Accepted format: edr."/>
                    <param name="ener_file2" type="data" format="edr" label="Energy file 2" help="Enter the second energy file. Accepted format: edr."/>
                    <param name="rel_tol" type="float" max="1.0" value="0.001" label="Enter relative tolerance" help="Relative tolerance for comparing real values defined as 2*(a-b)/(|a|+|b|)."/>
                    <param name="abs_tol" type="float" max="1.0" value="0.001" optional="True" label="Enter absolute tolerance" help="Absolute tolerance, useful when sums are close to zero."/>
                    <param name="lastener" type="text" value="all" label="Enter the last energy term to compare" help="Last energy term to compare. It makes sense to go up until the Pressure."/>
                </when>
            </conditional>
        </repeat>
    </inputs>
    <outputs>
        <data name="output">
            <discover_datasets pattern="(?P&lt;name&gt;.+\.txt)$" ext="txt" visible="true" directory="" assign_primary_output="true"/>
        </data>
    </outputs>
    <tests>
        <test>
            <repeat name="analysis">
                <conditional name="input_file">
                    <param name="calculate_select" value="info_traj"/>
                    <param name="traj_file" value="nvt.xtc" ftype="xtc"/>
                </conditional>
            </repeat>
            <output name="output" file="check_info_traj.txt" ftype="txt" lines_diff="4">
                <assert_contents>
                    <has_n_lines n="38"/>
                    <has_text text="Reading frame"/>
                    <has_text text="# Atoms  94"/>
                    <has_text text="Step            11    0.1"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <repeat name="analysis">
                <conditional name="input_file">
                    <param name="calculate_select" value="compare_traj"/>
                    <param name="traj_file" value="nvt.xtc" ftype="xtc"/>
                    <param name="traj_file2" value="npt.xtc" ftype="xtc"/>
                    <param name="rmsd" value="True"/>
                    <param name="rel_tol" value="0.1"/>
                    <param name="abs_tol" value="0.1"/>
                </conditional>
            </repeat>
            <output name="output" file="check_compare_traj.txt" ftype="txt" lines_diff="4">
                <assert_contents>
                    <has_n_lines n="62"/>
                    <has_text text="Reading frame"/>
                    <has_text text="Last frame         10 time    1.000"/>
                    <has_text text="x RMSD 0.135353"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <repeat name="analysis">
                <conditional name="input_file">
                    <param name="calculate_select" value="info_struc"/>
                    <param name="struc_file" value="minim.gro" ftype="gro"/>
                    <param name="vdwfac" value="0.8"/>
                    <param name="bonlo" value="0.4"/>
                    <param name="bonhi" value="0.7"/>
                </conditional>
            </repeat>
            <output name="output" file="check_info_structure.txt" ftype="txt" lines_diff="5">
                <assert_contents>
                    <has_n_lines n="480"/>
                    <has_text text="94 atoms in file"/>
                    <has_text text="coordinates found"/>
                    <has_text text="box         found"/>
                    <has_text text="no atoms found outside box"/>
                    <has_text text="atom# name  residue r_vdw  atom# name  residue r_vdw  distance"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <repeat name="analysis">
                <conditional name="input_file">
                    <param name="calculate_select" value="info_ener"/>
                    <param name="ener_file" value="minim.edr" ftype="edr"/>
                </conditional>
            </repeat>
            <repeat name="analysis">
                <conditional name="input_file">
                    <param name="calculate_select" value="info_ind"/>
                    <param name="ind_file" value="index.ndx" ftype="ndx"/>
                </conditional>
            </repeat>
            <output name="output" file="check_info_energy.txt" ftype="txt" lines_diff="4">
                <assert_contents>
                    <has_n_lines n="67"/>
                    <has_text text="Reading energy frame      1 time    1.000 "/>
                    <has_text text="31 groups in energy file"/>
                    <has_text text="Timesteps at t=20 don't match (2, 1)"/>
                    <has_text text="Found 25 frames."/>
                </assert_contents>
                <discovered_dataset designation='1.Index_information_for_"index.ndx".txt' file="check_info_index.txt" ftype="txt" lines_diff="4">
                    <assert_contents>
                        <has_n_lines n="28"/>
                        <has_text text="Contents of index file"/>
                        <has_text text="Nr.   Group               #Entries   First    Last"/>
                        <has_text text="  2  Protein-H                 43       1      92"/>
                        <has_text text="  10  Prot-Masses               92       1      92"/>
                    </assert_contents>
                </discovered_dataset>
            </output>
        </test>
        <test>
            <repeat name="analysis">
                <conditional name="input_file">
                    <param name="calculate_select" value="compare_top"/>
                    <param name="top_file" value="nvt.tpr" ftype="tpr"/>
                    <param name="top_file2" value="npt.tpr" ftype="tpr"/>
                    <param name="abs_tol" value="0.1"/>
                </conditional>
            </repeat>
            <output name="output" file="check_compare_topology.txt" ftype="txt" lines_diff="4">
                <assert_contents>
                    <has_n_lines n="1229"/>
                    <has_text text="maxresnr (7 - 5)"/>
                    <has_text text="comparing inputrec"/>
                    <has_text text="inputrec->nstxout (1000 - 50)"/>
                    <has_text text="ffparams->iparams[237]2: pos0A=( 1.25000000e-01, 1.25000000e-01, 0.00000000e+00)"/>
                    <has_text text="InteractionList entry[255] (259 - 236)"/>
                </assert_contents>
            </output>
        </test>
        <test>
            <repeat name="analysis">
                <conditional name="input_file">
                    <param name="calculate_select" value="compare_ener"/>
                    <param name="ener_file" value="minim.edr" ftype="edr"/>
                    <param name="ener_file2" value="outp.edr" ftype="edr"/>
                    <param name="rel_tol" value="0.1"/>
                    <param name="abs_tol" value="0.1"/>
                    <param name="lastener" value="Pressure"/>
                </conditional>
            </repeat>
            <output name="output" file="check_compare_energy.txt" ftype="txt" lines_diff="4">
                <assert_contents>
                    <has_n_lines n="199"/>
                    <has_text text="Reading energy frame"/>
                    <has_text text="enm[12] (- - Conserved En.)"/>
                    <has_text text="Angle            step   1:       536.268,  step   1:      188.647"/>
                    <has_text text="step (3 - 150)"/>
                    <has_text text="Coul. recip.     step  14:       914.559,  step  14:      304.201"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[

.. class:: infomark

**What it does**

This tool reads a trajectory (.tng, .trr or .xtc), an energy file (.edr) or an index file (.ndx) and prints out useful information about them.

Option -c checks for presence of coordinates, velocities and box in the file, for close contacts (smaller than -vdwfac and not bonded, i.e. not between -bonlo and -bonhi, all relative to the sum of both Van der Waals radii) and atoms outside the box (these may occur often and are no problem). If velocities are present, an estimated temperature will be calculated from them.

If an index file, is given its contents will be summarized.

The program can compare two run input (.tpr) files when both -s1 and -s2 are supplied. When comparing run input files this way, the default relative tolerance is reduced to 0.000001 and the absolute tolerance set to zero to find any differences not due to minor compiler optimization differences, although you can of course still set any other tolerances through the options.Similarly a pair of trajectory files can be compared (using the -f2 option), or a pair of energy files (using the -e2 option).

_____

.. class:: infomark

**Inputs**

**Information about a trajectory**
    - Trajectory file : -f option. Trajectory file in xtc, trr, cpt, gro, g96, pdb or tng format.

**Compare two trajectories**
    - Trajectory file 1 : -f option. Trajectory file in xtc, trr, cpt, gro, g96, pdb or tng format.
    - Trajectory file 2 : -f2 option. Trajectory file in xtc, trr, cpt, gro, g96, pdb or tng format.
    - Do you want to display the RMSD? : -rmsd option. Print RMSD for x, v and f.
    - Enter relative tolerance : -tol option. Relative tolerance for comparing real values.
    - Enter absolute tolerance : -abstol option. Absolute tolerance, useful when sums are close to zero.

**Information about the structure of a system**
    - Structure file : -c option. Structure file in tpr, gro, g96, pdb, brk or ent format.
    - Enter the fraction of sum of VdW radii : -vdwfac option.
    - Enter the minimal fraction of sum of vdW radii for bonded atoms : -bonlo option.
    - Enter the maximal fraction of sum of vdW radii for bonded atoms : -bonhi option.

**Information about the energy of a system**
    - Energy file : -e option. Energy file in edr format.

**Information about the index of a system**
    - Index file : -n option. Index file in ndx format.

**Compare two topologies**
    - Topology file 1 : -s1 option. Topology file in tpr format.
    - Topology file 2 : -s2 option. Topology file in tpr format.
    - Enter absolute tolerance : -abstol option. Absolute tolerance, useful when sums are close to zero.

**Compare two energy files**
    - Energy file 1 : -e option. Energy file in edr format.
    - Energy file 2 : -e2 option. Energy file in edr format.
    - Enter relative tolerance : -tol option. Relative tolerance for comparing real values.
    - Enter absolute tolerance : -abstol option. Absolute tolerance, useful when sums are close to zero.
    - Enter the last energy term to compare : -lastener. Last energy term to compare (if not given all are tested). It makes sense to go up until the Pressure.

The -ab option is not implemented.

_____

.. class:: infomark

**Output**

    - list with one or more TXT files. This file contains either information about the trajectory, the structure, the index or the energy, or a comparison between two trajectories, two topologies or two energy files.

    ]]></help>
    <citations>
        <citation type="doi">10.1016/j.softx.2015.06.001</citation>
    </citations>
</tool>
